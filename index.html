<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Azure Local Bootstrap Script Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --panel:#0b1020; --border:#1f2937; --good:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:1rem 1.25rem; background:#111827; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:1; }
    h1 { margin:0; font-size:1.1rem; }
    main { max-width:1200px; margin:0 auto; padding:1rem; display:grid; gap:1rem; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:10px; }
    .card h2 { margin:0; padding:0.75rem 1rem; border-bottom:1px solid var(--border); font-size:1rem; color:var(--muted); }
    .content { padding:1rem; }
    .grid { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); }
    .grid2 { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); }
    label { display:grid; gap:0.35rem; font-size:0.9rem; color:var(--muted); }
    input[type="text"], input[type="password"], select, textarea {
      width:100%; background:#0a1222; color:var(--fg); border:1px solid var(--border);
      border-radius:8px; padding:0.6rem 0.7rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      transition: border-color .15s ease;
    }
    .row, .inline { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
    .btnbar { display:flex; gap:0.5rem; flex-wrap:wrap; }
    button { background:#0a1222; border:1px solid var(--border); border-radius:8px; color:#fff; padding:0.55rem 0.8rem; cursor:pointer; }
    button.primary { background:var(--accent); color:#06131b; border-color:#0ea5e9; }
    button.good { background:var(--good); color:#062612; border-color:#16a34a; }
    pre { margin:0; white-space:pre; overflow:auto; max-height:640px; background:#071020; border:1px solid var(--border); border-radius:8px; padding:1rem; }
    .hint { color:var(--muted); font-size:0.9rem; }
    .pill { display:inline-block; background:#0a1222; border:1px solid var(--border); border-radius:999px; padding:0.2rem 0.5rem; margin-left:0.5rem; font-size:0.8rem; color:#cbd5e1; }
    .warning { background:#1f2937; border-left:4px solid var(--warn); padding:0.75rem; border-radius:6px; color:#fde68a; }
    .section-title { margin:0.5rem 0; font-weight:700; color:#cbd5e1; }
    .checkbox { display:flex; align-items:center; gap:0.5rem; color:#e5e7eb; }
    .divider { border-top:1px dashed var(--border); margin:0.75rem 0; }

    /* Validation styles */
    .error { border-color: var(--err) !important; }
    .err-msg { color:#fca5a5; font-size:0.82rem; min-height:1em; }
    .form-alert { color:#fde68a; background:#1f2937; border-left:4px solid var(--warn); padding:0.5rem 0.75rem; border-radius:6px; margin:0.5rem 0 0; display:none; }
    .form-alert.show { display:block; }
    .small { font-size:0.85rem; color:#94a3b8; }
  </style>
</head>
<body>
<header>
  <h1>Azure Local Bootstrap Script Generator <span class="pill">static · GitHub Pages‑friendly</span></h1>
</header>

<main>
  <section class="card">
    <h2>1) Configuration</h2>
    <div class="content">
      <div class="warning">
        <strong>Admin required:</strong> Run the generated script in an elevated PowerShell session.
      </div>

      <!-- Presets -->
      <p class="section-title">Presets (optional)</p>
      <div class="grid2">
        <label>Preset
          <select id="presetSelect">
            <option value="none" selected>None (manual)</option>
            <option value="integratedNic1Dual">Integrated NIC 1 · Ports 1-1 & 2-1 (primary 1-1)</option>
            <option value="slotDual">Slot X · Ports 1 & 2 (primary Port 1)</option>
          </select>
        </label>
        <label id="slotNumberWrap" style="display:none">Slot number (for Slot X preset)
          <input id="slotNumber" type="text" value="2" />
          <small class="small">Example: primary <code>Slot 2 Port 1</code>; VLAN on ports 1 & 2.</small>
        </label>
      </div>

      <div class="divider"></div>

      <!-- Network -->
      <p class="section-title">Network</p>
      <div class="grid2">
        <label>Primary interface alias (static IP target)
          <input id="ifaceAlias" type="text" value="Integrated NIC 1 Port 1-1" />
        </label>
        <label>Static IPv4 address
          <input id="ipAddress" type="text" value="10.184.69.101" />
          <small id="err-ipAddress" class="err-msg"></small>
        </label>
        <label>Default gateway
          <input id="gateway" type="text" value="10.184.69.1" />
          <small id="err-gateway" class="err-msg"></small>
        </label>
        <label>Prefix length (CIDR)
          <input id="prefix" type="text" value="24" />
          <small id="err-prefix" class="err-msg"></small>
        </label>
      </div>

      <div class="inline">
        <label class="checkbox"><input id="toggleDhcpOff" type="checkbox" checked /> Disable DHCP on non‑NDIS adapters</label>
        <label class="checkbox"><input id="toggleDisableDisconnected" type="checkbox" checked /> Disable disconnected adapters</label>
        <label class="checkbox"><input id="toggleSetStatic" type="checkbox" checked /> Set static IPv4 on primary alias</label>
      </div>

      <div class="divider"></div>

      <!-- VLAN -->
      <p class="section-title">VLAN (Management network)</p>
      <div class="grid2">
        <label>VLAN ID
          <input id="vlanId" type="text" value="900" />
          <small id="err-vlanId" class="err-msg"></small>
        </label>
        <label>Mode
          <select id="vlanMode">
            <option value="aliases" selected>Aliases (comma‑separated)</option>
            <option value="pattern">Name pattern (wildcards)</option>
          </select>
        </label>
      </div>

      <div id="vlanAliasesWrap" class="grid2">
        <label>Interface aliases for VLAN (CSV)
          <input id="vlanAliases" type="text" value="Integrated NIC 1 Port 1-1, Integrated NIC 1 Port 2-1" />
          <small id="err-vlanAliases" class="err-msg"></small>
        </label>
      </div>

      <div id="vlanPatternWrap" class="grid2" style="display:none">
        <label>Name pattern (wildcards allowed)
          <input id="vlanPattern" type="text" placeholder='e.g., Integrated NIC 1 Port *-1 or Slot * Port *' />
          <small id="err-vlanPattern" class="err-msg"></small>
        </label>
      </div>

      <div class="inline">
        <label class="checkbox"><input id="toggleVlan" type="checkbox" checked /> Apply VLAN to selected adapters</label>
      </div>

      <!-- DNS -->
      <div class="grid2">
        <label>DNS servers (comma‑separated IPv4; applied to primary alias)
          <input id="dnsServers" type="text" value="10.110.30.216,10.110.93.254" />
          <small id="err-dnsServers" class="err-msg"></small>
        </label>
      </div>
      <div class="inline">
        <label class="checkbox"><input id="toggleDns" type="checkbox" checked /> Set DNS servers on primary alias</label>
      </div>

      <div class="divider"></div>

      <!-- Remote & Firewall -->
      <p class="section-title">Remote Access & Firewall</p>
      <div class="inline">
        <label class="checkbox"><input id="toggleRdp" type="checkbox" checked /> Enable RDP (registry + firewall)</label>
        <label class="checkbox"><input id="togglePing" type="checkbox" checked /> Allow inbound ICMPv4 echo</label>
        <label class="checkbox"><input id="toggleWinRM" type="checkbox" checked /> winrm quickconfig</label>
      </div>

      <div class="divider"></div>

      <!-- Cluster Service registry -->
      <p class="section-title">Cluster Service Registry (optional)</p>
      <div class="inline">
        <label class="checkbox"><input id="toggleClusSvc" type="checkbox" checked /> Create clussvc keys + ExcludeAdaptersByDescription</label>
      </div>

      <div class="divider"></div>

      <!-- Time / NTP -->
      <p class="section-title">Time / NTP</p>
      <div class="grid2">
        <label>NTP peers (comma‑separated IPv4)
          <input id="ntpPeers" type="text" value="10.110.30.156,10.110.90.223" />
          <small id="err-ntpPeers" class="err-msg"></small>
        </label>
      </div>
      <div class="inline">
        <label class="checkbox"><input id="toggleNtp" type="checkbox" checked /> Configure W32Time</label>
        <label class="checkbox"><input id="toggleNtpStatus" type="checkbox" checked /> Query status</label>
      </div>

      <div class="divider"></div>

      <!-- Computer name -->
      <p class="section-title">Computer Name</p>
      <div class="grid2">
        <label>New computer name
          <input id="newComputerName" type="text" value="USMOSD8E1ASHH01" />
        </label>
      </div>
      <div class="inline">
        <label class="checkbox"><input id="toggleRename" type="checkbox" checked /> Rename computer</label>
        <label class="checkbox"><input id="toggleRestart" type="checkbox" checked /> Restart after rename</label>
      </div>

      <div class="divider"></div>

      <!-- Proxy & WinInetProxy -->
      <p class="section-title">Proxy & WinInetProxy module</p>
      <div class="grid2">
        <label>Proxy server URL
          <input id="proxyServer" type="text" value="http://pzen.fpl.com:10262" />
        </label>
        <label>Proxy bypass list (tokens supported: <code>ADD_SITE-SUBNET</code> / <code>SUBNET</code>, <code>HOSTNAME1</code>, <code>HOSTNAME2</code>, <code>CLUSTERNAME</code>)
          <input id="proxyBypass" type="text" value="localhost,127.0.0.1,*.fpl.com,10.*.*.*,172.16.*.*,192.168.*.*,169.254.*.*,ADD_SITE-SUBNET,HOSTNAME1,HOSTNAME2,CLUSTERNAME" />
        </label>
      </div>
      <div class="inline">
        <label class="checkbox"><input id="toggleDownloadModule" type="checkbox" checked /> Download & import WinInetProxy module</label>
        <label class="checkbox"><input id="toggleSetProxy" type="checkbox" checked /> Set WinINet & WinHTTP proxy</label>
      </div>

      <div class="divider"></div>

      <!-- Arc init -->
      <p class="section-title">Azure Stack HCI Arc Initialization</p>
      <div class="grid2">
        <label>Tenant ID
          <input id="tenantId" type="text" value="a1681294-4857-4624-8d04-edaddb44ee26" />
        </label>
        <label>Subscription ID
          <input id="subscriptionId" type="text" value="85a51444-f74a-4b48-9312-bf884d60394d" />
        </label>
        <label>Resource Group
          <input id="resourceGroup" type="text" value="z-jb630-ashedge-prod-eastus-rg-sd8" />
        </label>
        <label>Region
          <input id="region" type="text" value="eastus" />
        </label>
      </div>
      <div class="inline">
        <label class="checkbox"><input id="toggleArcInit" type="checkbox" checked /> Invoke AzStack HCI Arc Initialization</label>
        <label class="checkbox"><input id="toggleArcUseProxy" type="checkbox" checked /> Include proxy args</label>
      </div>

      <div id="formAlert" class="form-alert">Fix the highlighted fields to enable Copy/Download.</div>

      <div class="btnbar" style="margin-top:0.75rem">
        <button class="primary" id="btnPreview">Preview</button>
        <button id="btnCopy" disabled>Copy</button>
        <button class="good" id="btnDownload" disabled>Download .ps1</button>
      </div>
      <p class="hint">Tip: To validate interface names, run: <code>Get-NetAdapter | Select Name, Status</code></p>
    </div>
  </section>

  <section class="card">
    <h2>2) Preview</h2>
    <div class="content">
      <pre id="preview"></pre>
    </div>
  </section>
</main>

<script>
  // --- Utilities ---
  const CRLF = s => s.replace(/\r?\n/g, "\r\n");
  const psq = s => `'${String(s ?? "").replace(/'/g, "''")}'`; // single-quote safe
  const csv = s => String(s || "").split(",").map(x => x.trim()).filter(Boolean);
  const g = id => document.getElementById(id);
  const val = id => g(id).value.trim();
  const on = id => g(id).checked;
  const lines = arr => arr.filter(l => l !== null && l !== undefined).join("\n");

  // --- IPv4 Validation ---
  const ipv4Re = /^(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)$/;
  const isIPv4 = s => ipv4Re.test(s);
  const setError = (id, msg) => { g(id).classList.add('error'); const e = g('err-' + id); if (e) e.textContent = msg || ''; };
  const clearError = (id) => { g(id).classList.remove('error'); const e = g('err-' + id); if (e) e.textContent = ''; };

  function validateIPv4Field(id, required = true) {
    const v = val(id);
    if (!v && !required) { clearError(id); return true; }
    if (!v) { setError(id, 'Required'); return false; }
    if (!isIPv4(v)) { setError(id, 'Enter a valid IPv4 address (e.g., 10.0.0.1)'); return false; }
    clearError(id); return true;
  }
  function validateIPv4CsvField(id, required = true) {
    const items = csv(val(id));
    if (!items.length) { if (required) { setError(id, 'Provide at least one IPv4 address'); return false; } clearError(id); return true; }
    const bad = items.filter(x => !isIPv4(x));
    if (bad.length) { setError(id, 'Invalid IPv4: ' + bad.join(', ')); return false; }
    clearError(id); return true;
  }
  function validateNumberInRange(id, min, max, required = true) {
    const v = val(id);
    if (!v && !required) { clearError(id); return true; }
    if (!/^\d+$/.test(v)) { setError(id, `Enter a number ${min}-${max}`); return false; }
    const n = Number(v);
    if (n < min || n > max) { setError(id, `Enter a number ${min}-${max}`); return false; }
    clearError(id); return true;
  }
  function validateCsvNonEmpty(id, required = true) {
    const items = csv(val(id));
    if (!items.length && required) { setError(id, 'Provide at least one alias'); return false; }
    clearError(id); return true;
  }
  function validateAll() {
    let ok = true;

    if (on('toggleSetStatic')) {
      ok = validateIPv4Field('ipAddress', true) && ok;
      ok = validateIPv4Field('gateway', true) && ok;
      ok = validateNumberInRange('prefix', 0, 32, true) && ok;
    } else { clearError('ipAddress'); clearError('gateway'); clearError('prefix'); }

    if (on('toggleVlan')) {
      ok = validateNumberInRange('vlanId', 1, 4094, true) && ok;
      const mode = g('vlanMode').value;
      if (mode === 'aliases') ok = validateCsvNonEmpty('vlanAliases', true) && ok;
      else { if (!val('vlanPattern')) { setError('vlanPattern', 'Pattern required'); ok = false; } else clearError('vlanPattern'); }
    } else { clearError('vlanId'); clearError('vlanAliases'); clearError('vlanPattern'); }

    if (on('toggleDns')) ok = validateIPv4CsvField('dnsServers', true) && ok;
    else clearError('dnsServers');

    if (on('toggleNtp')) ok = validateIPv4CsvField('ntpPeers', true) && ok;
    else clearError('ntpPeers');

    g('formAlert').classList.toggle('show', !ok);
    g('btnCopy').disabled = !ok;
    g('btnDownload').disabled = !ok;
    return ok;
  }

  // --- Presets ---
  function applyPreset() {
    const preset = g('presetSelect').value;
    g('slotNumberWrap').style.display = (preset === 'slotDual') ? '' : 'none';

    if (preset === 'integratedNic1Dual') {
      g('ifaceAlias').value = 'Integrated NIC 1 Port 1-1';
      g('vlanMode').value = 'aliases';
      g('vlanAliases').value = 'Integrated NIC 1 Port 1-1, Integrated NIC 1 Port 2-1';
    } else if (preset === 'slotDual') {
      const n = val('slotNumber') || '2';
      g('ifaceAlias').value = `Slot ${n} Port 1`;
      g('vlanMode').value = 'aliases';
      g('vlanAliases').value = `Slot ${n} Port 1, Slot ${n} Port 2`;
    }
  }
  function syncVlanModeVisibility() {
    const mode = g('vlanMode').value;
    g('vlanAliasesWrap').style.display = (mode === 'aliases') ? '' : 'none';
    g('vlanPatternWrap').style.display = (mode === 'pattern') ? '' : 'none';
  }

  // --- ProxyBypass token replacement ---
  function getSubnetWildcardFromIp(ip) {
    if (!isIPv4(ip)) return '';
    const p = ip.split('.');
    return `${p[0]}.${p[1]}.${p[2]}.*`;
  }
  // Base = computer name without trailing 'H' + 2 digits; else use full
  function getBaseFromComputerName(name) {
    const m = String(name || '').match(/^(.+?)H\d{2}$/i);
    return m ? m[1] : String(name || '');
  }
  function applyBypassTokens(templateCsv, subnetWildcard, compName) {
    const base = getBaseFromComputerName(compName);
    const host1 = base + 'H01';
    const host2 = base + 'H02';
    const cluster = base + 'C01'; // first cluster always C01

    let out = String(templateCsv || '');
    out = out
      .replace(/ADD_SITE-SUBNET/gi, subnetWildcard)
      .replace(/\bSUBNET\b/gi, subnetWildcard)
      .replace(/HOSTNAME1/gi, host1)
      .replace(/HOSTNAME2/gi, host2)
      .replace(/CLUSTERNAME/gi, cluster);

    return out.split(',').map(s => s.trim()).filter(Boolean).join(',');
  }

  // --- Build script ---
  function buildScript() {
    // Inputs
    const ifaceAlias = val("ifaceAlias");
    const ip = val("ipAddress");
    const gw = val("gateway");
    const prefix = val("prefix");

    const vlanId = val("vlanId");
    const vlanMode = g("vlanMode").value;
    const vlanAliases = csv(val("vlanAliases"));
    const vlanPattern = val("vlanPattern");

    const dnsList = csv(val("dnsServers"));
    const ntpPeers = csv(val("ntpPeers"));
    const newName = val("newComputerName");

    const proxy = val("proxyServer");
    const bypassTemplate = val("proxyBypass");

    const tenant = val("tenantId");
    const sub = val("subscriptionId");
    const rg = val("resourceGroup");
    const region = val("region");

    // Toggles
    const tgDhcpOff = on("toggleDhcpOff");
    const tgDisableDisc = on("toggleDisableDisconnected");
    const tgSetStatic = on("toggleSetStatic");
    const tgVlan = on("toggleVlan");
    const tgDns = on("toggleDns");
    const tgRdp = on("toggleRdp");
    const tgPing = on("togglePing");
    const tgWinRM = on("toggleWinRM");
    const tgClusSvc = on("toggleClusSvc");
    const tgNtp = on("toggleNtp");
    const tgNtpStatus = on("toggleNtpStatus");
    const tgRename = on("toggleRename");
    const tgRestart = on("toggleRestart");
    const tgDownloadModule = on("toggleDownloadModule");
    const tgSetProxy = on("toggleSetProxy");
    const tgArcInit = on("toggleArcInit");
    const tgArcUseProxy = on("toggleArcUseProxy");

    // Derived bypass
    const subnetWildcard = getSubnetWildcardFromIp(ip);
    const processedBypass = applyBypassTokens(bypassTemplate, subnetWildcard, newName);

    // Header
    const header = [
      "# ================================================",
      "# Generated Azure Local Bootstrap Script",
      `# Generated: ${new Date().toISOString()}`,
      "# ================================================",
      "$ErrorActionPreference = 'Stop'",
      "Set-StrictMode -Version Latest",
      ""
    ];

    // Network
    const net = [];
    if (tgDhcpOff) net.push(`Get-NetAdapter | ? InterfaceDescription -inotmatch "NDIS" | Set-NetIPInterface -Dhcp Disabled`);
    if (tgDisableDisc) net.push(`Get-NetAdapter | Where-Object { $_.status -eq "disconnected" } | Disable-NetAdapter -Confirm:$false`);
    if (tgSetStatic) {
      net.push(`New-NetIPAddress -InterfaceAlias ${psq(ifaceAlias)} -IPAddress ${psq(ip)} -DefaultGateway ${psq(gw)} -PrefixLength ${psq(prefix)} -AddressFamily IPv4 -Verbose`);
    }
    if (tgVlan) {
      if (vlanMode === 'aliases') {
        vlanAliases.forEach(a => net.push(`Get-NetAdapter -Name ${psq(a)} | Set-NetAdapter -VlanID ${psq(vlanId)} -Confirm:$false`));
      } else {
        net.push(`Get-NetAdapter -Name ${psq(vlanPattern)} | Set-NetAdapter -VlanID ${psq(vlanId)} -Confirm:$false`);
      }
    }
    if (tgDns) net.push(`Set-DnsClientServerAddress -InterfaceAlias ${psq(ifaceAlias)} -ServerAddresses ${dnsList.join(",")}`);

    // Access
    const access = [];
    if (tgRdp) {
      access.push(
        `Set-ItemProperty -Path "HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server" -Name "fDenyTSConnections" -Value 0`,
        `Enable-NetFirewallRule -DisplayGroup "Remote Desktop"`
      );
    }
    if (tgClusSvc) {
      access.push(
        `New-Item -Path HKLM:\\system\\currentcontrolset\\services\\clussvc -ErrorAction SilentlyContinue | Out-Null`,
        `New-Item -Path HKLM:\\system\\currentcontrolset\\services\\clussvc\\parameters -ErrorAction SilentlyContinue | Out-Null`,
        `New-ItemProperty -Path HKLM:\\system\\currentcontrolset\\services\\clussvc\\parameters -Name ExcludeAdaptersByDescription -Value "Remote NDIS Compatible Device" -ErrorAction SilentlyContinue | Out-Null`
      );
    }
    if (tgWinRM) access.push(`winrm quickconfig`);
    if (tgPing) access.push(`netsh advfirewall firewall add rule name="ICMP Allow incoming V4 echo request" protocol=icmpv4:8,any dir=in action=allow`);

    // Time
    const time = [];
    if (tgNtp && ntpPeers.length) {
      const peersLit = ntpPeers.join(",");
      time.push(`w32tm /config /manualpeerlist:${psq(peersLit)} /syncfromflags:manual /update`);
    }
    if (tgNtpStatus) time.push(`w32tm /query /status`);

    // Rename
    const rename = [];
    if (tgRename && newName) {
      rename.push(`Rename-Computer -NewName ${psq(newName)}${tgRestart ? " -Restart" : ""}`);
    }

    // Proxy & module
    const proxyBlock = [];
    if (tgDownloadModule) {
      const modUrl = `https://www.powershellgallery.com/api/v2/package/WinInetProxy/0.1.0`;
      const proxyArg = proxy ? ` -Proxy ${psq(proxy)}` : "";
      proxyBlock.push(
        `Invoke-WebRequest -Uri ${psq(modUrl)} -OutFile C:\\WinInetProxy.zip${proxyArg}`,
        `Expand-Archive -Path C:\\WinInetProxy.zip -DestinationPath C:\\wininetproxy\\ -Force`,
        `Import-Module -Name C:\\wininetproxy\\WinInetProxy.psm1`
      );
    }
    if (tgSetProxy && proxy) {
      proxyBlock.push(
        `$ProxyBypassList = ${psq(processedBypass)}`,
        `$proxyserver = ${psq(proxy)}`,
        `Set-WinInetProxy -ProxySettingsPerUser 0 -ProxyServer $proxyserver -ProxyBypass $ProxyBypassList`,
        `Set-winhttpproxy -proxyserver $proxyserver -BypassList $ProxyBypassList`
      );
    }

    // Arc init
    const arc = [];
    if (tgArcInit) {
      let cmd = `Invoke-AzStackHciArcInitialization -TenantID ${psq(tenant)} -SubscriptionID ${psq(sub)} -ResourceGroup ${psq(rg)} -Region ${psq(region)} -Cloud "AzureCloud"`;
      if (tgArcUseProxy && proxy) cmd += ` -Proxy ${psq(proxy)} -ProxyBypass ${psq(processedBypass)}`;
      arc.push(cmd);
    }

    const parts = [
      ...header,
      ...(net.length ? ["# --- Network ---", ...net, ""] : []),
      ...(access.length ? ["# --- Access & Firewall ---", ...access, ""] : []),
      ...(time.length ? ["# --- Time / NTP ---", ...time, ""] : []),
      ...(rename.length ? ["# --- Rename ---", ...rename, ""] : []),
      ...(proxyBlock.length ? ["# --- Proxy & WinInetProxy Module ---", ...proxyBlock, ""] : []),
      ...(arc.length ? ["# --- Azure Stack HCI Arc Initialization ---", ...arc, ""] : []),
      `# Completed.`
    ];
    return lines(parts);
  }

  // --- UI update / actions ---
  function updatePreview() {
    applyPreset();            // apply preset (no change if "none")
    syncVlanModeVisibility(); // show/hide VLAN alias/pattern inputs
    const script = buildScript();
    g('preview').textContent = script;
    validateAll();
  }

  function downloadPs1() {
    if (!validateAll()) return;
    const content = CRLF(buildScript());
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "azure-local-bootstrap.ps1";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyToClipboard() {
    if (!validateAll()) return;
    await navigator.clipboard.writeText(buildScript());
    const btn = g("btnCopy");
    const prev = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(() => btn.textContent = prev, 1200);
  }

  // Wire up events
  g('btnPreview').addEventListener('click', updatePreview);
  g('btnDownload').addEventListener('click', downloadPs1);
  g('btnCopy').addEventListener('click', copyToClipboard);
  document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updatePreview));
  document.querySelectorAll('input[type="checkbox"]').forEach(el => el.addEventListener('change', updatePreview));
  g('presetSelect').addEventListener('change', updatePreview);
  g('slotNumber').addEventListener('input', updatePreview);
  g('vlanMode').addEventListener('change', updatePreview);

  // First render
  updatePreview();
</script>
</body>
</html>
