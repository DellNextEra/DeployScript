<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Azure Local Bootstrap PowerShell Script Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --panel:#0b1020; --border:#1f2937; --good:#22c55e; --warn:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:1rem 1.25rem; background:#111827; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:1; }
    h1 { margin:0; font-size:1.1rem; }
    main { max-width:1200px; margin:0 auto; padding:1rem; display:grid; gap:1rem; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:10px; }
    .card h2 { margin:0; padding:0.75rem 1rem; border-bottom:1px solid var(--border); font-size:1rem; color:var(--muted); }
    .content { padding:1rem; }
    .grid { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); }
    .grid2 { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); }
    label { display:grid; gap:0.35rem; font-size:0.9rem; color:var(--muted); }
    input[type="text"], input[type="password"], select, textarea {
      width:100%; background:#0a1222; color:var(--fg); border:1px solid var(--border);
      border-radius:8px; padding:0.6rem 0.7rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .row { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
    .btnbar { display:flex; gap:0.5rem; flex-wrap:wrap; }
    button { background:#0a1222; border:1px solid var(--border); border-radius:8px; color:var(--fg); padding:0.55rem 0.8rem; cursor:pointer; }
    button.primary { background:var(--accent); color:#06131b; border-color:#0ea5e9; }
    button.good { background:var(--good); color:#062612; border-color:#16a34a; }
    pre { margin:0; white-space:pre; overflow:auto; max-height:640px; background:#071020; border:1px solid var(--border); border-radius:8px; padding:1rem; }
    .hint { color:var(--muted); font-size:0.9rem; }
    .pill { display:inline-block; background:#0a1222; border:1px solid var(--border); border-radius:999px; padding:0.2rem 0.5rem; margin-left:0.5rem; font-size:0.8rem; color:var(--muted); }
    .warning { background:#1f2937; border-left:4px solid var(--warn); padding:0.75rem; border-radius:6px; color:#fde68a; }
    .section-title { margin:0.5rem 0; font-weight:700; color:#cbd5e1; }
    .checkbox { display:flex; align-items:center; gap:0.5rem; color:#e5e7eb; }
    .divider { border-top:1px dashed var(--border); margin:0.75rem 0; }
  </style>
</head>
<body>
<header>
  <h1>Windows Host Bootstrap Script Generator <span class="pill">static · GitHub Pages‑friendly</span></h1>
</header>

<main>
  <section class="card">
    <h2>1) Configuration</h2>
    <div class="content">
      <div class="warning">
        <strong>Admin required:</strong> Most actions here require running the generated script in an elevated PowerShell session.
      </div>

      <p class="section-title">Network</p>
      <div class="grid2">
        <label>Interface alias (static IP target)
          <input id="ifaceAlias" type="text" value="Integrated NIC 1 Port 1-1" />
        </label>
        <label>Static IPv4 address
          <input id="ipAddress" type="text" value="10.184.69.101" />
        </label>
        <label>Default gateway
          <input id="gateway" type="text" value="10.184.69.1" />
        </label>
        <label>Prefix length (CIDR)
          <input id="prefix" type="text" value="24" />
        </label>
        <label>VLAN ID (applied to adapters named <code>Integrated*</code>)
          <input id="vlanId" type="text" value="900" />
        </label>
        <label>DNS servers (comma‑separated)
          <input id="dnsServers" type="text" value="10.110.30.216,10.110.93.254" />
        </label>
      </div>

      <div class="row">
        <label class="checkbox"><input id="toggleDhcpOff" type="checkbox" checked /> Disable DHCP on adapters whose description does <em>not</em> match “NDIS”</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleDisableDisconnected" type="checkbox" checked /> Disable disconnected adapters</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleSetStatic" type="checkbox" checked /> Set static IPv4 on the specified interface</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleVlan" type="checkbox" checked /> Set VLAN ID on <code>Integrated*</code> adapters</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleDns" type="checkbox" checked /> Set DNS servers on the specified interface</label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Remote Access & Firewall</p>
      <div class="row">
        <label class="checkbox"><input id="toggleRdp" type="checkbox" checked /> Enable RDP (registry + firewall group “Remote Desktop”)</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="togglePing" type="checkbox" checked /> Allow inbound ICMPv4 echo (ping)</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleWinRM" type="checkbox" checked /> <code>winrm quickconfig</code></label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Cluster Service Registry (optional)</p>
      <div class="row">
        <label class="checkbox"><input id="toggleClusSvc" type="checkbox" checked /> Create clussvc keys + <code>ExcludeAdaptersByDescription</code> (“Remote NDIS Compatible Device”)</label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Time / NTP</p>
      <div class="grid2">
        <label>NTP peers (comma‑separated)
          <input id="ntpPeers" type="text" value="10.110.30.156,10.110.90.223" />
        </label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleNtp" type="checkbox" checked /> Configure W32Time with peers</label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleNtpStatus" type="checkbox" checked /> Query W32Time status</label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Computer Name</p>
      <div class="grid2">
        <label>New computer name
          <input id="newComputerName" type="text" value="USMOSD8E1ASHH01" />
        </label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleRename" type="checkbox" checked /> Rename computer</label>
        <label class="checkbox"><input id="toggleRestart" type="checkbox" checked /> Restart after rename</label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Proxy & WinInetProxy module</p>
      <div class="grid2">
        <label>Proxy server URL
          <input id="proxyServer" type="text" value="http://pzen.fpl.com:10262" />
        </label>
        <label>Proxy bypass list (comma‑separated)
          <input id="proxyBypass" type="text" value="localhost,127.0.0.1,*.fpl.com,10.*.*.*,172.16.*.*,192.168.*.*,169.254.*.*,ADD_SITE-SUBNET,HOSTNAME1,HOSTNAME2,CLUSTERNAME" />
        </label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleDownloadModule" type="checkbox" checked /> Download & import WinInetProxy module</label>
        <label class="checkbox"><input id="toggleSetProxy" type="checkbox" checked /> Set WinINet & WinHTTP proxy</label>
      </div>

      <div class="divider"></div>

      <p class="section-title">Azure Stack HCI Arc Initialization</p>
      <div class="grid2">
        <label>Tenant ID
          <input id="tenantId" type="text" value="a1681294-4857-4624-8d04-edaddb44ee26" />
        </label>
        <label>Subscription ID
          <input id="subscriptionId" type="text" value="85a51444-f74a-4b48-9312-bf884d60394d" />
        </label>
        <label>Resource Group
          <input id="resourceGroup" type="text" value="z-jb630-ashedge-prod-eastus-rg-sd8" />
        </label>
        <label>Region
          <input id="region" type="text" value="eastus" />
        </label>
      </div>
      <div class="row">
        <label class="checkbox"><input id="toggleArcInit" type="checkbox" checked /> Invoke AzStack HCI Arc Initialization</label>
        <label class="checkbox"><input id="toggleArcUseProxy" type="checkbox" checked /> Include proxy args in Arc init</label>
      </div>

      <div class="btnbar" style="margin-top:0.75rem">
        <button class="primary" id="btnPreview">Preview</button>
        <button id="btnCopy" disabled>Copy</button>
        <button class="good" id="btnDownload" disabled>Download .ps1</button>
      </div>
      <p class="hint">Tip: Validate interface alias and IPs for your hardware before running.</p>
    </div>
  </section>

  <section class="card">
    <h2>2) Preview</h2>
    <div class="content">
      <pre id="preview"></pre>
    </div>
  </section>
</main>

<script>
  // --- Utilities ---
  const CRLF = s => s.replace(/\r?\n/g, "\r\n");
  const psq = s => `'${String(s ?? "").replace(/'/g, "''")}'`; // single-quote safe
  const csv = s => String(s || "").split(",").map(x => x.trim()).filter(Boolean);

  const g = id => document.getElementById(id);
  const val = id => g(id).value.trim();
  const on = id => g(id).checked;

  function lines(arr){ return arr.filter(l => l !== null && l !== undefined).join("\n"); }

  function buildScript() {
    // Gather values
    const ifaceAlias = val("ifaceAlias");
    const ip = val("ipAddress");
    const gw = val("gateway");
    const prefix = val("prefix");
    const vlanId = val("vlanId");
    const dnsList = csv(val("dnsServers"));

    const ntpPeers = csv(val("ntpPeers"));
    const newName = val("newComputerName");

    const proxy = val("proxyServer");
    const bypass = val("proxyBypass");

    const tenant = val("tenantId");
    const sub = val("subscriptionId");
    const rg = val("resourceGroup");
    const region = val("region");

    // Toggles
    const tgDhcpOff = on("toggleDhcpOff");
    const tgDisableDisc = on("toggleDisableDisconnected");
    const tgSetStatic = on("toggleSetStatic");
    const tgVlan = on("toggleVlan");
    const tgDns = on("toggleDns");

    const tgRdp = on("toggleRdp");
    const tgPing = on("togglePing");
    const tgWinRM = on("toggleWinRM");

    const tgClusSvc = on("toggleClusSvc");

    const tgNtp = on("toggleNtp");
    const tgNtpStatus = on("toggleNtpStatus");

    const tgRename = on("toggleRename");
    const tgRestart = on("toggleRestart");

    const tgDownloadModule = on("toggleDownloadModule");
    const tgSetProxy = on("toggleSetProxy");

    const tgArcInit = on("toggleArcInit");
    const tgArcUseProxy = on("toggleArcUseProxy");

    // Header
    const header = [
      "# ================================================",
      "# Generated Windows Host Bootstrap Script",
      `# Generated: ${new Date().toISOString()}`,
      "# ================================================",
      "$ErrorActionPreference = 'Stop'",
      "Set-StrictMode -Version Latest",
      ""
    ];

    // Network configuration
    const net = [];
    if (tgDhcpOff) {
      net.push(`Get-NetAdapter | ? InterfaceDescription -inotmatch "NDIS" | Set-NetIPInterface -Dhcp Disabled`);
    }
    if (tgDisableDisc) {
      net.push(`Get-NetAdapter | Where-Object { $_.status -eq "disconnected" } | Disable-NetAdapter -Confirm:$false`);
    }
    if (tgSetStatic) {
      net.push(
        `New-NetIPAddress -InterfaceAlias ${psq(ifaceAlias)} -IPAddress ${psq(ip)} -DefaultGateway ${psq(gw)} -PrefixLength ${psq(prefix)} -AddressFamily IPv4 -Verbose`
      );
    }
    if (tgVlan) {
      net.push(`Get-NetAdapter -Name Integrated* | Set-NetAdapter -VlanID ${psq(vlanId)} -Confirm:$false`);
    }
    if (tgDns) {
      // join DNS servers as comma separated literal (no quotes around commas)
      net.push(`Set-DnsClientServerAddress -InterfaceAlias ${psq(ifaceAlias)} -ServerAddresses ${dnsList.join(",")}`);
    }

    // RDP / Firewall / WinRM
    const access = [];
    if (tgRdp) {
      access.push(
        `Set-ItemProperty -Path "HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server" -Name "fDenyTSConnections" -Value 0`,
        `Enable-NetFirewallRule -DisplayGroup "Remote Desktop"`
      );
    }
    if (tgClusSvc) {
      access.push(
        `New-Item -Path HKLM:\\system\\currentcontrolset\\services\\clussvc -ErrorAction SilentlyContinue | Out-Null`,
        `New-Item -Path HKLM:\\system\\currentcontrolset\\services\\clussvc\\parameters -ErrorAction SilentlyContinue | Out-Null`,
        `New-ItemProperty -Path HKLM:\\system\\currentcontrolset\\services\\clussvc\\parameters -Name ExcludeAdaptersByDescription -Value "Remote NDIS Compatible Device" -ErrorAction SilentlyContinue | Out-Null`
      );
    }
    if (tgWinRM) {
      access.push(`winrm quickconfig`);
    }
    if (tgPing) {
      access.push(`netsh advfirewall firewall add rule name="ICMP Allow incoming V4 echo request" protocol=icmpv4:8,any dir=in action=allow`);
    }

    // Time / NTP
    const time = [];
    if (tgNtp && ntpPeers.length) {
      const peersLit = ntpPeers.join(",");
      time.push(`w32tm /config /manualpeerlist:${psq(peersLit)} /syncfromflags:manual /update`);
    }
    if (tgNtpStatus) {
      time.push(`w32tm /query /status`);
    }

    // Rename
    const rename = [];
    if (tgRename && newName) {
      rename.push(`Rename-Computer -NewName ${psq(newName)}${tgRestart ? " -Restart" : ""}`);
    }

    // Proxy & module
    const proxyBlock = [];
    if (tgDownloadModule) {
      const modUrl = `https://www.powershellgallery.com/api/v2/package/WinInetProxy/0.1.0`;
      // If a proxy is provided, include -Proxy on Invoke-WebRequest
      const proxyArg = proxy ? ` -Proxy ${psq(proxy)}` : "";
      proxyBlock.push(
        `Invoke-WebRequest -Uri ${psq(modUrl)} -OutFile C:\\WinInetProxy.zip${proxyArg}`,
        `Expand-Archive -Path C:\\WinInetProxy.zip -DestinationPath C:\\wininetproxy\\ -Force`,
        `Import-Module -Name C:\\wininetproxy\\WinInetProxy.psm1`
      );
    }
    if (tgSetProxy && proxy) {
      proxyBlock.push(
        `$ProxyBypassList = ${psq(bypass)}`,
        `$proxyserver = ${psq(proxy)}`,
        `Set-WinInetProxy -ProxySettingsPerUser 0 -ProxyServer $proxyserver -ProxyBypass $ProxyBypassList`,
        `Set-winhttpproxy -proxyserver $proxyserver -BypassList $ProxyBypassList`
      );
    }

    // Azure Stack HCI Arc Initialization
    const arc = [];
    if (tgArcInit) {
      let cmd = `Invoke-AzStackHciArcInitialization -TenantID ${psq(tenant)} -SubscriptionID ${psq(sub)} -ResourceGroup ${psq(rg)} -Region ${psq(region)} -Cloud "AzureCloud"`;
      if (tgArcUseProxy && proxy) {
        cmd += ` -Proxy ${psq(proxy)} -ProxyBypass ${psq(bypass)}`;
      }
      arc.push(cmd);
    }

    const parts = [
      ...header,
      ...(net.length ? ["# --- Network ---", ...net, ""] : []),
      ...(access.length ? ["# --- Access & Firewall ---", ...access, ""] : []),
      ...(time.length ? ["# --- Time / NTP ---", ...time, ""] : []),
      ...(rename.length ? ["# --- Rename ---", ...rename, ""] : []),
      ...(proxyBlock.length ? ["# --- Proxy & WinInetProxy Module ---", ...proxyBlock, ""] : []),
      ...(arc.length ? ["# --- Azure Stack HCI Arc Initialization ---", ...arc, ""] : []),
      `# Completed.`
    ];

    return lines(parts);
  }

  function updatePreview() {
    const script = buildScript();
    const preview = g('preview');
    preview.textContent = script;
    const disabled = script.trim().length < 10;
    g('btnCopy').disabled = disabled;
    g('btnDownload').disabled = disabled;
  }

  function downloadPs1() {
    const content = CRLF(buildScript());
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "windows-bootstrap.ps1";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyToClipboard() {
    await navigator.clipboard.writeText(buildScript());
    const btn = g("btnCopy");
    const prev = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(() => btn.textContent = prev, 1200);
  }

  // Wire up
  g('btnPreview').addEventListener('click', updatePreview);
  g('btnDownload').addEventListener('click', downloadPs1);
  g('btnCopy').addEventListener('click', copyToClipboard);
  document.querySelectorAll('input').forEach(el => el.addEventListener('input', updatePreview));

  // Initial render
  updatePreview();
</script>
</body>
</html>
